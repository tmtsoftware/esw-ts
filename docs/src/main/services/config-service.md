# Config Service

The Config Service provides a centralized persistent store for any configuration file used in the TMT Software
System. All versions of configuration files are retained, providing a historical record of each configuration file.
This client exposes simple methods to access and manage configuration files.

## Rules and Checks

1. The config file path must not contain `!#<>$%&'@^``~+,;=` or any whitespace character
1. If the input file is > 10MB or has lots of non ASCII characters, then for optimization, server will archive it in
`annex` store.
1. Large and binary files can be forced to go to the `annex` store by using `annex=true` flag in create operation.

## Model Classes

- ConfigData: Represents the contents of the files being managed. It wraps blob object.
- ConfigFileInfo: Represents information about a config file stored in the Config Service.
- ConfigFileRevision: Represents information about a specific version of a config file.
- ConfigId: Represents an identifier associated with a revision of a configuration file, often generated by create or
update methods.
- ConfigMetadata: Represents metadata information about the Config Server.
- FileType: Represents the type of storage for a configuration file. Currently, two types are supported
`Normal(small, text files)` and `Annex(Large, Binary files)`.

### Example for creation ConfigData and accessing data with helper function

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #config-data }

Note: Models other than `ConfigData` are simple TypeScript classes and do not have special helper methods unlike `ConfigData`.

## Pre-requisite

### In order to use config service

1. The Location Service and Config Service Server needs to be running in the network
2. The necessary configuration, environment variables or system properties should be defined to point to the correct
   host and port number(s) for the Location Service nodes.
3. Authorization Token with correct access role.
   Documentation on how to fetch authorization token could be found @ref[here](../aas/auth-components.md).

## Creation of Config Service

### To create a client for Config service

Config Service constructor takes `TokenFactory` as an input argument.

Typescript
: @@snip [Location-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #config-service }

@@@ note {title="Async-Await" }

Note that the examples are using async/await which makes handling of promises more readable.

@@@

## Usages of Config Service

Type Definitions of all methods can be found @extref:[here](ts-docs:interfaces/clients.configservice.html)

## Creating File

This method takes `path` at which `configData` needs to be saved in the Config Service along with meta information i.e
whether to be saved as `annex` or `normal` file and comment. After saving, it returns `ConfigId` which can be used to
access the saved file in the future using query methods.

Type definitions of `create` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#create)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #create }

## Updating File

This method takes `path` at which `configData` needs to be updated in the Config Service along with comment.
After updating, it returns `ConfigId` which can be used to access the updated file in future using query methods.

Type definitions of `update` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#update)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #update }

## Fetching Files

The Config Service provides multiple ways to fetch a file from the svn repository based on `Time`, `ConfigId`,`Active`, and `Latest Revision`.

Following are the methods available to fetch files:

 - `getActive`
 - `getById`
 - `getByTime`
 - `getLatest`

Examples for each of the methods are as follows:

- **getActive** : This method return the `ConfigData` of the active version for that file if it exists otherwise returns undefined.

Type definitions of `getActive` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#getactive)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #get-active }

- **getLatest** : This method returns the `ConfigData` of the latest revision for that file if it exists otherwise returns undefined.

Type definitions of `getLatest` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#getlatest)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #get-latest }

- **getById** : This method returns `ConfigData` based on the given `ConfigId` if it exists otherwise returns undefined.

Type definitions of `getById` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#getbyid)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #get-by-id }

- **getByTime** : This method gets the `ConfigData` at the given path as it existed at a given time-instance.

Note:
-If time-instance is before the file was created, the initial version is returned.
-If time-instance is after the last change, the most recent version is returned.

Type definitions of `getByTime` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#getbytime)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #get-by-time }

## Checking file existence

This method checks whether file exists at the given `path` and optional specific `configId` in the repository and returns
true if it does exist or else false.

Type definitions of `exists` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#exists)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #exists }

## Deleting File

This method deletes a file located at specified `path` in the repository.

Type definitions of `delete` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#delete)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #delete }

## Listing files

This method list all the files for a given `FileType` (`Annex` or `Normal`) and an optional pattern string, it will list all
files with the file path matching the given pattern.

Some pattern examples are: `“/path/hcd/*.*”`, `“a/b/c/d.*”`, `“.*.conf”`, `“.*hcd.*”`

Type definitions of `list` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#list)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #list }

## Fetching revision history of a file

This method returns the history of revisions of the file at the given `path` for a range of period specified by `from`
and `to`.

The size of the list can be restricted using `maxResults`.

Type definitions of `history` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#history)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #history }

## Getting Config Service Metadata

This method returns metadata information about the Config Service.
It includes:

- repository directory
- annex directory
- min annex file size
- max config file size

Type definitions of `getMetadata` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#getmetadata)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #get-metadata }

## Managing active versions

In its lifetime, a config file undergoes many revisions. An active version is a specific revision from a file’s
history, and it is set by administrators.

### historyActive

This method returns the history of `active` revisions of the file at the given `path` for a range of period specified by
`from` and `to`.
The size of the list can be restricted using `maxResults`.

Type definitions of `historyActive` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#historyactive)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #history-active }

### setActiveVersion

This method sets the "active version" to be the version provided for the file at the given path.
If this method is never called in a Config’s lifetime, the active version will always be the version returned by create
function.

Type definitions of `setActiveVersion` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#setactiveversion)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #set-active-version }

### resetActiveVersion

This method resets the "active version" of the file at the given path to the latest version.

Type definitions of `resetActiveVersion` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#resetactiveversion)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #reset-active-version }

### getActiveVersion

This method returns the revision ID which represents the "active version" of the file at the given path.

Type definitions of `getActiveVersion` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#getactiveversion)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #get-active-version }

### getActiveByTime

This method returns the content of `active` version of the file existed at given instant of `Time`

Type definitions of `getActiveByTime` method can be found @extref:[here](ts-docs:interfaces/clients.configservice.html#getactivebytime)

Typescript
: @@snip [Config-Service](../../../../example/src/documentation/config/ConfigExample.ts) { #get-active-by-time }
